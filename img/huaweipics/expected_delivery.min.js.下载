ec.pkg("ec.product");ec.load("ajax");ec.load("ec.dh");ec.load("ec.aes");ec.load("ec.rc4");var _defaultAddress=["\u5e7f\u4e1c","\u6df1\u5733","\u9f99\u5c97\u533a"];var _defaultTimeOut=10000;var address=[];var tree_url=domainShoppingConfig+"/data/region/tree/{id}.json";var children_url=domainShoppingConfig+"/data/region/children/{id}.json";var addressInfoMap={};var commonAddress={};var _tempAddress=[];var _tempAddressIds=[];var addressConfig=null;var cache={},ajaxer;var skuAddress;var ipAddress=[];var ipAddressCookie=[];ec.product.parseUrl=function(a,b){return a.replace(/{id}/g,b)};ec.product.processAddress=function(b){_tempAddressIds=[];_tempAddress=[];skuAddress=b;var c=address[0];var a=[];a.push("<dt>\u9009\u62e9\u65b0\u5730\u5740</dt>");if(c!=null&&c!=""){a.push('<dd id="provice" level-value="1" data-value="" class="current">'+c+"</dd>")}else{a.push('<dd id="provice" level-value="1" data-value="">\u8bf7\u9009\u62e9</dd>')}a.push('<dd id="city" level-value="2" data-value="">\u8bf7\u9009\u62e9</dd>');a.push('<dd id="district" level-value="3" data-value="">\u8bf7\u9009\u62e9</dd>');$("#provice_info").html(a.join(""));$("#provice_info").find("dd").bind("click",ec.product.againSelectAddress);ec.product.queryData(ec.product.parseUrl(tree_url,"0"),true,1,ec.product.queryProvince)};ec.product.againSelectAddress=function(){var c=$(this).attr("data-value");var a=parseInt($(this).attr("level-value"));if((c==null||c=="")&&a!=1){return}$(".address-new").find("dd").removeClass();switch(a){case 1:$("#provice").addClass("current");$("#city").html("\u8bf7\u9009\u62e9");break;case 2:$("#city").addClass("current");break;case 3:$("#district").addClass("current");break}if(a==1){ec.product.queryData(ec.product.parseUrl(tree_url,"0"),true,1,ec.product.queryProvince)}else{var b=parseInt(c);ec.product.queryData(ec.product.parseUrl(children_url,b),true,a,ec.product.queryProvince)}};ec.product.selectedAddress=function(){var c=$(this).attr("districtId");var a=$(this).attr("id");var b=skuAddress.price;ec.util.cookie.set("selectedAddress",$(this).attr("provinceId")+"|"+$(this).attr("cityId")+"|"+c,{expires:30,domain:".vmall.com"});ec.util.cookie.set("shopAddressID",a,{expires:30,domain:".vmall.com"});ec.product.showAddress(commonAddress[a]);ec.prescription.getEstimateGetOrderTime(ec.product.showSupportDisplayDilieryTime,c,b,null)};ec.product.changeAddress=function(){var c=$(this).attr("id");_tempAddressIds.push(c);_tempAddress.push($(this).html());var a=ec.product.replaceChar($(this).html());var b=parseInt($(this).attr("addrType"));$(".address-new").find("dd").removeClass();switch(b){case 1:$("#provice").html(a);$("#city").attr("data-value",c);$("#city").addClass("current");break;case 2:$("#city").html(a);$("#district").attr("data-value",c);$("#district").addClass("current");break;case 3:$("#district").html(a);$("#district").attr("data-value",c);$("#district").addClass("current");$("#address_table").hide();break}if(b<3){ec.product.queryData(ec.product.parseUrl(children_url,c),true,b+1,ec.product.queryProvince)}else{if(b==3&&_tempAddress.length==3&&_tempAddressIds.length==3){address=_tempAddress;ec.product.showAddress(address);ec.prescription.getEstimateGetOrderTime(ec.product.showSupportDisplayDilieryTime,_tempAddressIds[2],skuAddress.price,null);ec.util.cookie.set("selectedAddress",_tempAddressIds[0]+"|"+_tempAddressIds[1]+"|"+_tempAddressIds[2],{expires:30,domain:".vmall.com"})}}};ec.product.userAddress=function(e,f){var d=[],b=e;d.push("<dt>\u5e38\u7528\u5730\u5740</dt>");commonAddress={};for(var a=0;a<b.length;a++){var c=[];var g=b[a].provinceName;var j=b[a].cityName;var h=ec.product.replaceChar(b[a].districtName);d.push('<dd id="'+b[a].id+'" provinceId="'+b[a].province+'" cityId="'+b[a].city+'" districtId = "'+b[a].district+'">'+j+"&nbsp;"+h+"</dd>");addressInfoMap[b[a].id]=g+"&nbsp;"+j+"&nbsp;"+h+b[a].streetName+"&nbsp;"+b[a].address;c.push(g);c.push(j);c.push(b[a].districtName);commonAddress[b[a].id]=c}$("#in_common_use_address").html(d.join(""));$("#in_common_use_address").find("dd").bind("click",ec.product.selectedAddress);$("#address_normal_effective_time").find("dl>dd").hover(function(){var i=$(this).attr("id");ec.product.queryTips(i,$(this))},function(){var i=$(this).attr("id");$("#deatilAddress").html("");$("#deatilAddress").hide()})};ec.product.queryTips=function(a,b){$("#deatilAddress").html(addressInfoMap[a]);$("#deatilAddress").css("position","absolute");$("#deatilAddress").css("z-index","9999");$("#deatilAddress").css("top",(parseInt(b.position().top)+b.innerHeight()+12)+"px");$("#deatilAddress").css("display","block");$("#deatilAddress").show()};ec.product.queryProvince=function(f,g,h){var c;if(g==1){c=f.data[0]}else{c=f.data}var e=[];var a=c.length;e.push('<table style="min-height=180px;" width="100%" border="0" cellpadding="0" cellspacing="0">');e.push("<tbody>");var d=0;for(var b=0;b<a;b++){if(d==0){e.push("<tr>")}var j=ec.product.replaceChar(c[b].name);e.push('<td id="'+c[b].id+'" addrType="'+g+'">'+j+"</td>");d=d+1;if(d==4||b==a-1){d=0;e.push("</tr>")}}e.push("</tbody>");e.push("</table>");$("#address_table").css({"min-height":"180px"}).html(e.join(""));$("#address_table").find("td").bind("click",ec.product.changeAddress);$("#address_table").show();if(ec.account.isLogin()){ec.addr.list(ec.product.userAddress)}};ec.product.queryData=function(a,c,d,e){var b;if(c&&(b=cache[a])){return e(b,d)}if(ajaxer){ajaxer.abort()}ajaxer=$.ajax({url:a,type:"get",dataType:"jsonp",success:function(f){if(c){cache[a]=f}e(f,d)},error:function(g,f){logger.warn("load data fail.")}})};ec.product.processExpectDelivery=function(h){address=[];skuAddress=h;if(ec.product.status==3){return}if(ec.product.seCode!=ec.product.productSeCode||parseInt(ec.product.productType)!=0){return}var g=ec.product.inventory.haveInventory(skuAddress.id);if(!g){return}var i=skuAddress.buttonMode;if(parseInt(i)!=1&&parseInt(i)!=10){return}if(parseInt(i)==10){var d=ec.product.getSysDate();var e=ec.product.getSkuInfo(skuAddress.id||ec.product.defaultSku).endTime;var f=new Date();if(null==e||""==e){f=new Date(2999,1,1,0,0,0)}else{f.setTime(e.parseDate("yyyy-MM-dd HH:mm:ss"))}if((d-f)>0){return}}var b=ec.util.cookie.get("selectedAddress");if(b==null){if(ec.account.isLogin()){ec.product.getUserDefaultAddress()}else{ec.product.parseCookie()}}else{var c=b.split("|");if(c.length==3){var a=c[2];ec.product.queryData(ec.product.parseUrl(tree_url,a),true,1,ec.product.getCitydistrict)}}};ec.product.processSupportDisplayDilieryTime=function(c){if(ec.product.isSupportDisTime=="0"){return}ec.product.hiddenTips();var b=[];b.push(c.id);for(var a=0;a<c.giftList.length;a++){b.push(c.giftList[a].giftId)}$.ajax({url:"/product/realInventory.json?t="+new Date().getTime(),type:"get",dataType:"json",data:{skuids:b.join(",")},timeout:10000,success:function(f){if(f.success){var e=f.skuInventoryList;for(var d=0;d<e.length;d++){if(!e[d].hasInventory){return}ec.product.processExpectDelivery(c)}}else{}},error:function(){}})};ec.product.parseCookie=function(){var b=ec.util.cookie.get("ipaddress");if(b!=null){var e=b.split(",");var a=[];for(var d=0;d<3;d++){a[d]=e[d]}ec.product.showAddress(a);var c=skuAddress.price;ec.prescription.getEstimateGetOrderTime(ec.product.showSupportDisplayDilieryTime,e[3],c,"-1")}else{ec.product.getUserAddressByIP(ec.product.addressCall)}};ec.product.getCitydistrict=function(e){address=[];var j=e.values;var a=e.data[0];for(var c=0;c<a.length;c++){var h=a[c];if(h.id==j[0]){address.push(h.name)}}var b=e.data[1];for(var c=0;c<b.length;c++){var h=b[c];if(h.id==j[1]){address.push(h.name)}}var g=e.data[2];for(var c=0;c<g.length;c++){var h=g[c];if(h.id==j[2]){address.push(h.name)}}var f=j[2];if($.trim(f)==""){ec.product.hiddenTips();return}ec.product.showAddress(address);var d=skuAddress.price;ec.prescription.getEstimateGetOrderTime(ec.product.showSupportDisplayDilieryTime,f,d,null)};ec.product.addressCall=function(a){var b=[];ipAddress=[];ipAddressCookie=[];if(a!=null&&a!=undefined&&a.success&&(a.address.province!=null&&a.address.province!="null"&&$.trim(a.address.province)!="")){b.push(a.address.province);ipAddress.push(a.address.province);if(a.address.city=="null"||a.address.city==null||$.trim(a.address.city)==""){b.push(null);ec.product.getAddressId(b,ec.product.queryAddressByName)}else{if(a.address.district=="null"||a.address.district==null||$.trim(a.address.district)==""){b.push(a.address.city);ipAddress.push(a.address.city);b.push(null);ec.product.getAddressId(b,ec.product.queryAddressByName)}else{b.push(a.address.city);b.push(a.address.district);address=b;ipAddressCookie[0]=b;ec.product.getAddressId(address,ec.product.setIpCookie)}}}else{address=_defaultAddress;ec.product.getAddressId(address,ec.product.getAddressIdCallBack)}};ec.product.queryAddressByName=function(b,f){var a=[];var d=b.provinceId;var e=b.cityId;var c=b.districtId;if((e!=null&&e!="")&&(c==null||c=="")){ec.product.queryData(ec.product.parseUrl(children_url,parseInt(e)),true,2,ec.product.queryCitydistrict)}else{ec.product.queryData(ec.product.parseUrl(children_url,parseInt(d)),true,1,ec.product.queryCitydistrict)}};ec.product.queryCitydistrict=function(a,c){var b=a.data;if(b==null||$.trim(b)==""||b==undefined){address=_defaultAddress;ec.product.getAddressId(_defaultAddress,ec.product.getAddressIdCallBack)}else{var d=b[0].id;ipAddress.push(b[0].name);if(parseInt(c)==1){ec.product.queryData(ec.product.parseUrl(children_url,parseInt(d)),true,2,ec.product.queryCitydistrict)}else{address=ipAddress;ipAddressCookie.push(ipAddress);ec.product.getAddressId(ipAddress,ec.product.setIpCookie)}}};ec.product.saveIPAddressToCookie=function(a){ec.util.cookie.set("ipaddress",a,{expires:1/12,domain:".vmall.com"})};ec.product.setIpCookie=function(b){var a=b.districtId;ipAddressCookie.push(a);ec.product.saveIPAddressToCookie(ipAddressCookie);ec.product.getAddressIdCallBack(b)};ec.product.getUserDefaultAddress=function(){var d="13232376895198612407547930718267435757728527029623408872245156039757713029036368719146452186041204237350521785240337048752071462798273003935646236777459223";var e="5421644057436475141609648488325705128047428394380474376834667300766108262613900542681289080713724597310673074119355136085795982097390670890367185141189796";var a=ec.encipher.randomInt(128);var f=ec.encipher.bigPowMod(e,a,d);var c=[];$.ajax({url:domainShoppingConfig+"/member/smyAddresses/default.json",dataType:"jsonp",data:{pubkey:f,seType:"r"},jsonpCallback:"defaulltAddressCallback",timeout:_defaultTimeOut,async:false,success:function(b){if(!b.success||b.shoppingConfg==null||b.shoppingConfg==""){ec.product.parseCookie();return}ec.util.cookie.set("sc_p",b.pubkey);K=ec.encipher.bigPowMod(b.pubkey,a,d);var g=ec.encipher.decrypt(b.shoppingConfg,K);g=g.replaceAll("	"," ");g=ec.lang.json.parse(g);c.push(g.provinceName);c.push(g.cityName);c.push(g.districtName);if(c==null||c.length==0){ec.product.parseCookie()}else{address=c;ec.product.getAddressId(address,ec.product.getAddressIdCallBack)}},error:function(){address=_defaultAddress;ec.product.getAddressId(_defaultAddress,ec.product.getAddressIdCallBack)}})};ec.product.showSupportDisplayDilieryTime=function(e,d){var b="\u6682\u65f6\u65e0\u6cd5\u7ed9\u51fa\u9884\u8ba1\u5230\u8d27\u65f6\u95f4\uff0c\u5982\u6709\u7591\u95ee\u8054\u7cfb\u5ba2\u670d";if(!d){if(e){var a=e.deliveryTime;var c=ec.product.getEffectivenessTime(a);b="23:00\u524d\u5b8c\u6210\u652f\u4ed8\uff0c\u9884\u8ba1"+c+"\u9001\u8fbe"}}$("#pro-predict").find("span:first").html(b);ec.product.showTips()};ec.product.getUserAddressByIP=function(a){$.ajax({url:"/ip/location.json",type:"get",dataType:"jsonp",jsonpCallback:"userAddressByIPCallback",timeout:_defaultTimeOut,success:function(b){a(b)},error:function(){address=_defaultAddress;ec.product.getAddressId(address,ec.product.getAddressIdCallBack)}})};ec.product.getAddressIdCallBack=function(c){var a=c.districtId;if($.trim(a)==""){ec.product.hiddenTips();return}ec.product.showAddress(address);var b=skuAddress.price;ec.prescription.getEstimateGetOrderTime(ec.product.showSupportDisplayDilieryTime,a,b,null)};ec.product.getAddressId=function(a,b){$.ajax({url:domainShoppingConfig+"/matchRegion.json",type:"get",dataType:"jsonp",data:{provinceName:a[0],cityName:a[1],districtName:a[2]},jsonpCallback:"addressCallback",timeout:_defaultTimeOut,success:function(c){if(c.success){b(c)}else{a=_defaultAddress;ec.product.getAddressId(_defaultAddress,ec.product.getAddressIdCallBack)}},error:function(){a=_defaultAddress;ec.product.getAddressId(_defaultAddress,ec.product.getAddressIdCallBack)}})};ec.product.showAddress=function(a){$("#address").find("a").html(a[0]+"-"+a[1]+"-"+ec.product.replaceChar(a[2]))};ec.product.hiddenTips=function(){$("#pro-predict").hide()};ec.product.showTips=function(){$("#pro-predict").show()};ec.product.getEffectivenessTime=function(b){var e;var d=ec.product.getSysDate();var g=d.getHours();var c=d.getTime();var f=new Date();f.setTime(c);if(g>=0&&g<23){f.setHours(23+b)}else{f.setDate(f.getDate()+1);f.setHours(23+b)}var a=(parseInt(f.getMonth())+1)+"\u6708"+f.getDate()+"\u65e5\uff08"+ec.product.getWeekByTime(f)+"\uff09";return a};ec.product.getWeekByTime=function(a){var b=a.getDay();var c="";switch(b){case 0:c="\u5468\u65e5";break;case 1:c="\u5468\u4e00";break;case 2:c="\u5468\u4e8c";break;case 3:c="\u5468\u4e09";break;case 4:c="\u5468\u56db";break;case 5:c="\u5468\u4e94";break;case 6:c="\u5468\u516d";break}return c};ec.product.replaceChar=function(a){if(a!=null&&a!=""&&a=="-"){return"\u5176\u5b83\u5730\u533a"}else{return a}};
